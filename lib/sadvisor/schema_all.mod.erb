# Total storage capacity
param max_space;

# Benefit of queries for configuration and configuration storage
set benefits, dimen 3;
set Sizes, dimen 2;
set Configurations, dimen 2;

# Indices
set Queries := setof{(i,j,c) in benefits : j == 1} i;
set Indexes := setof{(i,s) in Configurations} i;
set E := setof{(i,j) in Queries cross Indexes} (i, j);

# Assignment
var x{(i,j) in E}, >=0, <=1, binary;
var y{Indexes}, >=0, <=1, binary;

maximize obj :
  sum{(i,j,c) in benefits} x[i,j] * c;

s.t. size :
  sum{(i,c) in Sizes} c * y[i] <= max_space;

<% 1.upto(benefits.count) do |i| %>
s.t. q<%= i %>config :
  sum{(i,s) in Configurations} x[<%= i %>,i] <= 1;

<% end %>

<%
benefits.each_with_index do |qb, i|
  qb.each_with_index do |b, j|
    next unless b > 0
    configurations[j].each do |index| %>
s.t. q_<%= i + 1 %>_<%= j + 1 %>_<%= index %>_avail :
  x[<%= i + 1 %>,<%= j + 1 %>] <= y[<%= index %>];

<%
    end
  end
end %>

solve;

# Output the configuration
printf {(i,s) in Configurations: y[i] == 1} "%i ", i;

data;

# Total storage capacity
param max_space := <%= max_space %>;

set Sizes :=
<% index_sizes.each_with_index do |size, i| %>
  <%= i + 1 %> <%= size %>

<% end %>;

set Configurations :=
<% configuration_sizes.each_with_index do |size, i| %>
  <%= i + 1 %> <%= size %>

<% end %>;

set benefits :=
<%
benefits.each_with_index do |qb, i|
  qb.each_with_index do |b, j| %>
  <%= i + 1 %> <%= j + 1 %> <%= b %>

<%
  end
end %>;

end;
