#!/usr/bin/env ruby

require 'hashids'
require 'json'
require 'ruby-progressbar'
require 'thor'

module Sadvisor
  class SadvisorCLI < Thor
    desc 'workload NAME', 'run the workload NAME'
    option :max_space, type: :numeric, default: Float::INFINITY
    option :format, type: :string, default: 'text'
    def workload(name)
      # rubocop:disable GlobalVars

      is_text = options[:format] == 'text'

      $LOAD_PATH.unshift File.dirname(__FILE__) + '/../lib'
      require 'sadvisor'
      require_relative "../workloads/#{name}"

      # Display progress while searching
      progress_thread = Thread.new do
        bar = ProgressBar.create title: 'Finding indexes', total: nil
        while true
          bar.increment
          sleep 0.1
        end
      end if $stdout.isatty and is_text

      indexes = Sadvisor::Search.new($workload) \
        .search_overlap(options[:max_space])
      simple_indexes = $workload.entities.values.map(&:simple_index)
      if progress_thread
        Thread.kill progress_thread
        puts "\n\n" if is_text
      end

      planner = Sadvisor::Planner.new $workload, (indexes + simple_indexes)
      plans = {}
      $workload.queries.each do |query|
        plans[query] = planner.min_plan query
      end

      indexes = plans.values.map(&:to_a).flatten.select do |step|
        step.is_a? Sadvisor::IndexLookupStep
      end.map(&:index).to_set

      header = "Indexes\n" + '━' * 50
      puts $stdout.isatty ? header.blue : header if is_text
      (simple_indexes.to_set + indexes).each { |index| puts index.inspect } if is_text
      puts if is_text

      total_size = (indexes - simple_indexes).map(&:size).inject(0, :+)
      puts ($stdout.isatty ? 'Total size: '.blue : 'Total size: ') + total_size.to_s if is_text
      puts if is_text

      # Output queries plans for the discovered indices
      header = "Query plans\n" + '━' * 50
      puts $stdout.isatty ? header.blue : header if is_text
      plans.each do |query, plan|
        puts query.inspect if is_text
        puts plan.inspect if is_text
        puts if is_text
      end

      if options[:format] == 'json'
        hash = Hashids.new
        state = {
          indexes: (indexes - simple_indexes).map do |index|
            index.state.update key: hash.encrypt(index.hash.abs)
          end,
          plans: plans.map do |query, plan|
            {
              query: query.text_value,
              steps: plan.map do |step|
                methods = (step.methods - PlanStep.instance_methods)
                {
                  type: step.class.name.downcase \
                    .sub('sadvisor::', '').sub('step', ''),
                  cost: step.cost
                }.update Hash[*methods.map do |method|
                  value = step.send(method)
                  value_hash = value.hash.abs
                  value = value.is_a?(Enumerable) ? \
                    value.map(&:state) : value.state if value
                  value[:key] = hash.encrypt(value_hash) if value.is_a? Hash
                  [method.to_s, value]
                end.flatten]
              end,
              cost: plan.cost
            }
          end,
          total_size: total_size,
          total_cost: $workload.query_weights.map do |query, weight|
            weight * plans[query].cost
          end.inject(0, &:+)
        }

        puts JSON.pretty_generate state
      end

      # rubocop:enable GlobalVars
    end
  end
end

Sadvisor::SadvisorCLI.start ARGV
